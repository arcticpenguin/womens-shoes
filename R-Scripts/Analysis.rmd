---
title: "Analysis"
output: html_document
---

### Setup
```{r}
library(imager)
library(wordcloud2)
library(tidyverse)
library(dplyr)

data <- data.frame(read.csv('../data/womens-shoe-prices.csv'))
```
# Remove items that aren't shoes
```{r}
nonshoes <- c('pants','jeans', 'jacket','cardigan', 'dress','shirt','romper','suit','pedicure', 'bra','underwire','wirefree','bikini','swim','lingerie','thong','slippers','pantyhose','hairpin',
              'swimsuit','swimwear','scarf','glove','leggings','eyewear','Sunglasses',"Costume",
              'dress','blazer','men\'s', 'skirt','coat','top','socks','Doll','sleepwear','makeup',
              'bracelet','necklace','jewelry','diamond','band','ring','watch','Parka','lens')

data_shoes <- data %>% 
  filter(!brand %in% c('TwoBirch','TBJE Wedding Bands','Yours Clothing','Brioni','GEMaffair',
                       'TheBeJeweledEgg Rings','Studs Galore','Techno-Marine','LUXURMAN',
                       'TBJE Slide Pendants','Peacock Diamonds','JUNGHANS','Ddi'), 
         !is.na(brand))%>% 
  filter(!grepl(paste(nonshoes, collapse = "|"),name, ignore.case = T)) 

```

### Taking a quick look at the data
```{r, message=FALSE, warning=FALSE}
# Keep useful columns
# df <- data_shoes[,c("id", "brand", "imageURLs", "prices.amountMin", "prices.amountMax", "prices.currency", "prices.isSale")]
df <- data_shoes

# Lets just keep the most popular 100 brands because no one cares about unbranded shoes, I think?
# brands <- data.frame(sort(table(df$brand), decreasing = TRUE))
# brands <- brands[2:101,]
# df <- df[which(df$brand %in% brands$Var1),]
```

### Do a little bit of cleaning
```{r, message=FALSE, warning=FALSE}
#Function to standardise the prices to USD, as there are several currencies
convertPrice <- function(currency, amount){
  ifelse(currency=='AUD', amount * 0.75,
  ifelse(currency=='CAD', amount * 0.73,
  ifelse(currency=='EUR', amount * 1.1,
  ifelse(currency=='GPB', amount * 1.3, 
         amount))))
}

#Convert price to numeric and USD
df$prices.amountMax <- as.numeric(as.character(df$prices.amountMax))
df$prices.amountMin <- as.numeric(as.character(df$prices.amountMin))
df$prices.amountMin <- convertPrice(df$prices.currency, df$prices.amountMin)
df$prices.amountMax <- convertPrice(df$prices.currency, df$prices.amountMax)

#Split image URLs so we can grab product images later
df$imageURLStr <- df$imageURLs
df$imageURLs <- as.character(df$imageURLs) %>% strsplit(",")
```

Turns out the ID field is duplicated, so different places are selling the exact same product. Let's collapse that, and assign the mean price to the item.

### Summarise the data by shoe ID
```{r, message=FALSE, warning=FALSE}
df.distinct <- df %>% distinct(id, .keep_all = TRUE) %>% select(-brand)

df.clean <- df %>%
  group_by(id) %>%
  dplyr::summarise(
            count = n(),
            brand = first(brand),
            price.max = mean(prices.amountMax, na.rm=TRUE),
            price.min = mean(prices.amountMin, na.rm=TRUE),
            price.avg = round((price.max + price.min) / 2),
            urls = as.character(imageURLs[1])
            ) %>%
  inner_join(df.distinct, by="id") %>%
  arrange(desc(price.avg)) %>%
  filter(!is.nan(price.avg))


```

There are some little errors in the brand names, so let's fix those duplicates!

```{r}
df.clean$brand <- ifelse(df.clean$brand=='PUMA', 'Puma', as.character(df.clean$brand))
df.clean$brand <- ifelse(df.clean$brand=='Lauren Ralph Lauren', 'Ralph Lauren', as.character(df.clean$brand))
df.clean$brand <- ifelse(df.clean$brand=='MICHAEL Michael Kors', 'Michael Kors', as.character(df.clean$brand))
df.clean$brand <- ifelse(df.clean$brand %in% c('Pleaser Shoes', 'PleaserUSA'), 'Pleaser', as.character(df.clean$brand))
```

#Output
```{r}
output <- df.clean %>% 
  select(
    -urls,
    -imageURLs)

write.csv(output, "filename.csv", na="", row.names=FALSE, sep=",")
```

### What brands are the most expensive?
```{r, message=FALSE, warning=FALSE}
df.clean %>% 
  group_by(brand) %>%
  dplyr::summarise(price = mean(price.avg, rm.na=true)) %>%
  filter(price > 100) %>%
  arrange(desc(price)) %>%
  top_n(20) %>%
  ggplot(mapping = aes(x=reorder(brand, price), y=price)) + 
    geom_bar(stat = "identity", aes(fill=price)) +
    theme_light() +
    scale_colour_gradient() +
    coord_flip() +
    labs(title="Expensive brands", x="Brand", y="Mean Price (USD)")

df.clean %>% 
  group_by(brand) %>%
  dplyr::summarise(price = mean(price.avg, rm.na=true)) %>%
  filter(price <= 100 & price > 50) %>%
  arrange(desc(price)) %>%
  top_n(20) %>%
  ggplot(mapping = aes(x=reorder(brand, price), y=price)) + 
    geom_bar(stat = "identity", aes(fill=price)) +
    theme_light() +
    scale_colour_gradient() +
    coord_flip() +
    labs(title="Mid range brands", x="Brand", y="Mean Price (USD)")

df.clean %>% 
  group_by(brand) %>%
  dplyr::summarise(price = mean(price.avg, rm.na=true)) %>%
  filter(price < 50) %>%
  arrange(desc(price)) %>%
  top_n(-20) %>%
  ggplot(mapping = aes(x=reorder(brand, price), y=price)) + 
    geom_bar(stat = "identity", aes(fill=price)) +
    theme_light() +
    scale_colour_gradient() +
    coord_flip() +
    labs(title="Cheap brands", x="Brand", y="Mean Price (USD)")
```

# Tests
```{r}
df.clean %>% 
  select(dateAdded) %>% 
  mutate(date=as.Date(dateAdded)) %>%
  summary()
df.clean %>%
  mutate(date=as.Date(dateAdded)) %>%
  ggplot(aes(y=price.avg, x=date)) + geom_point(alpha=0.5)

df.clean %>%
  mutate(date=as.Date(prices.dateAdded)) %>%
  ggplot(aes(x=date)) + geom_histogram(alpha=0.5)
```

I guess I was right about unbranded shoes? I wonder what the actual shoes look like? Now I'll use the image URL feature to download and plot the image.

### What do $7000 shoes look like?

```{r, eval=FALSE, include=TRUE}
#Grab the shoe image from the URL
getImage <- function(idx){
  if (!is.na(df.clean$urls[[idx]][1])) {
    tryCatch({
      download.file(df.clean$urls[[idx]][1] ,'image', mode = 'wb')
      a <- load.image('image')
      a <- resize(a, size_x = 150, size_y = 150)
      return(a) 
    }, error = function(err) {
      #error cant get image!
    })
    
  }
  return(imfill(100, 100, val=1)) ## Return a blank white image if NA
}

plotShoes <- function(idxs){
  op <- par(no.readonly=TRUE)
  par(mfrow=c(3,3), mar=c(.1,.1,.1,.1))
  
  for (i in idxs){
    j <- getImage(i)
    plot(j, axes=FALSE)
    text(10, 10, col="black", cex=1.5, paste('$',df.clean$price.avg[i]))
    text(10, 25, col="black", cex=1, paste(df.clean$brand[i]))
  }
  par(op)
}

plotShoes(1:9)
```
![Clearly, the top 9 shoes are not shoes!](http://puu.sh/vFFa3/d6e81aaef5.jpg) 

It turns out TwoBirch is a jewelry company. What do slightly less expensive shoes look like?

```{r, message=FALSE, warning=FALSE, eval=FALSE, include=TRUE}
plotShoes(41:49)
```
![These look like actual shoes](http://puu.sh/vFFd8/2577a36775.jpg)

What do the cheap shoes look like?

```{r, message=FALSE, warning=FALSE, eval=FALSE, include=TRUE}
plotShoes(3991:3999)

nonshoes <- c('pants','jeans', 'jacket','cardigan', 'dress','shirt','romper','suit','pedicure', 'bra','underwire','wirefree','bikini','swim','lingerie','thong','slippers','pantyhose','hairpin',
              'swimsuit','swimwear','scarf','glove','leggings','eyewear','Sunglasses',"Costume",
              'dress','blazer','men\'s', 'skirt','coat','top','socks','Doll','sleepwear','makeup',
              'bracelet','necklace','jewelry','diamond','band','ring','watch','Parka','lens')
```

